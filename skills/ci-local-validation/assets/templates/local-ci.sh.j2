#!/bin/bash
# Local CI Validation Script
# Generated by ci-local-validation skill
#
# Usage:
#   ./scripts/local-ci.sh              # Full validation
#   ./scripts/local-ci.sh --fast       # Fast mode (pyramid + unit tests)
#   ./scripts/local-ci.sh --pyramid    # Pyramid check only
#   ./scripts/local-ci.sh --markers    # Marker validation only
#   ./scripts/local-ci.sh --lint       # Linting only
#   ./scripts/local-ci.sh --help       # Show help

set -e

# Configuration
MINIMUM_PYRAMID_SCORE="{{ config.test_pyramid.get('minimum_score', 5.5) }}"
PROJECT_ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Counters
PASSED=0
FAILED=0
SKIPPED=0
START_TIME=$(date +%s)

# Parse arguments
MODE="full"
VERBOSE=false

while [[ $# -gt 0 ]]; do
    case $1 in
        --fast|-f)
            MODE="fast"
            shift
            ;;
        --pyramid|-p)
            MODE="pyramid"
            shift
            ;;
        --markers|-m)
            MODE="markers"
            shift
            ;;
        --lint|-l)
            MODE="lint"
            shift
            ;;
        --verbose|-v)
            VERBOSE=true
            shift
            ;;
        --help|-h)
            echo "Usage: $0 [OPTIONS]"
            echo ""
            echo "Options:"
            echo "  --fast, -f      Fast mode (pyramid + unit tests)"
            echo "  --pyramid, -p   Pyramid check only"
            echo "  --markers, -m   Marker validation only"
            echo "  --lint, -l      Linting only"
            echo "  --verbose, -v   Show detailed output"
            echo "  --help, -h      Show this help"
            exit 0
            ;;
        *)
            echo "Unknown option: $1"
            exit 1
            ;;
    esac
done

# Banner
echo ""
echo -e "${BLUE}==========================================${NC}"
echo -e "${BLUE}         Local CI Validation${NC}"
echo -e "${BLUE}==========================================${NC}"
echo -e "Mode: ${YELLOW}${MODE}${NC}"
echo -e "Time: $(date '+%Y-%m-%d %H:%M:%S')"
echo ""

# Helper functions
run_check() {
    local name="$1"
    local command="$2"
    local required="${3:-true}"

    printf "%-40s" "  $name..."

    if $VERBOSE; then
        echo ""
        if eval "$command"; then
            echo -e "${GREEN}✓ PASS${NC}"
            ((PASSED++))
            return 0
        else
            if [ "$required" = "true" ]; then
                echo -e "${RED}✗ FAIL${NC}"
                ((FAILED++))
                return 1
            else
                echo -e "${YELLOW}⚠ WARN${NC}"
                ((SKIPPED++))
                return 0
            fi
        fi
    else
        if eval "$command" > /dev/null 2>&1; then
            echo -e "${GREEN}✓ PASS${NC}"
            ((PASSED++))
            return 0
        else
            if [ "$required" = "true" ]; then
                echo -e "${RED}✗ FAIL${NC}"
                ((FAILED++))
                return 1
            else
                echo -e "${YELLOW}⚠ WARN${NC}"
                ((SKIPPED++))
                return 0
            fi
        fi
    fi
}

skip_check() {
    local name="$1"
    printf "%-40s" "  $name..."
    echo -e "${YELLOW}○ SKIP${NC}"
    ((SKIPPED++))
}

# Change to project root
cd "$PROJECT_ROOT"

# Activate virtual environment if exists
if [ -d ".venv" ]; then
    source .venv/bin/activate
fi

echo -e "${BLUE}Running checks...${NC}"
echo ""

# ============================================
# Test Pyramid Check
# ============================================
if [[ "$MODE" == "full" || "$MODE" == "fast" || "$MODE" == "pyramid" ]]; then
    run_check "Test Pyramid Score" \
        "python scripts/testing/pyramid-monitor.py --minimum-score $MINIMUM_PYRAMID_SCORE --format json > /tmp/pyramid.json && jq -e '.passed' /tmp/pyramid.json"
else
    skip_check "Test Pyramid Score"
fi

# ============================================
# Marker Validation
# ============================================
if [[ "$MODE" == "full" || "$MODE" == "fast" || "$MODE" == "markers" ]]; then
    run_check "Test Marker Validation" \
        "python scripts/testing/validate-markers.py --all"
else
    skip_check "Test Marker Validation"
fi

# ============================================
# Unit Tests
# ============================================
if [[ "$MODE" == "full" || "$MODE" == "fast" ]]; then
    run_check "Unit Tests" \
        "pytest -m unit -q --tb=no"
else
    skip_check "Unit Tests"
fi

# ============================================
# Integration Tests
# ============================================
if [[ "$MODE" == "full" ]]; then
    run_check "Integration Tests" \
        "pytest -m integration -q --tb=no"
else
    skip_check "Integration Tests"
fi

# ============================================
# E2E Tests
# ============================================
if [[ "$MODE" == "full" ]]; then
    run_check "E2E Tests" \
        "pytest -m e2e -q --tb=no"
else
    skip_check "E2E Tests"
fi

# ============================================
# Linting
# ============================================
if [[ "$MODE" == "full" || "$MODE" == "lint" ]]; then
{% if 'python' in [project.languages.primary] + project.languages.get('secondary', []) %}
    run_check "Python Lint (flake8)" \
        "flake8 src/ --count --statistics" \
        false  # Non-blocking

    run_check "Python Format (black)" \
        "black --check src/" \
        false  # Non-blocking
{% endif %}

{% if 'javascript' in [project.languages.primary] + project.languages.get('secondary', []) %}
    if [ -d "frontend" ]; then
        run_check "Frontend Lint (eslint)" \
            "cd frontend && npm run lint" \
            false  # Non-blocking
    fi
{% endif %}
else
    skip_check "Linting"
fi

# ============================================
# Frontend Tests (if exists)
# ============================================
{% if 'javascript' in [project.languages.primary] + project.languages.get('secondary', []) %}
if [[ "$MODE" == "full" && -d "frontend" ]]; then
    run_check "Frontend Unit Tests" \
        "cd frontend && npm run test -- --run"
else
    skip_check "Frontend Unit Tests"
fi
{% endif %}

# ============================================
# Summary
# ============================================
END_TIME=$(date +%s)
DURATION=$((END_TIME - START_TIME))

echo ""
echo -e "${BLUE}==========================================${NC}"
echo -e "${BLUE}                Summary${NC}"
echo -e "${BLUE}==========================================${NC}"
echo -e "  ${GREEN}Passed:${NC}  $PASSED"
echo -e "  ${RED}Failed:${NC}  $FAILED"
echo -e "  ${YELLOW}Skipped:${NC} $SKIPPED"
echo -e "  Duration: ${DURATION}s"
echo ""

if [ $FAILED -gt 0 ]; then
    echo -e "${RED}CI validation FAILED${NC}"
    echo "Fix the issues above before pushing."
    exit 1
else
    echo -e "${GREEN}CI validation PASSED${NC}"
    exit 0
fi
